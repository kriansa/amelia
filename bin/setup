#!/usr/bin/env ruby
# frozen_string_literal: true

require 'pathname'
require 'fileutils'

# path to your application root.
APP_ROOT = Pathname.new File.expand_path('../../', __FILE__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

FileUtils.chdir APP_ROOT do
  puts '== Installing Bundler =='
  system! 'gem install bundler --conservative'
  unless system('which bundle')
    if system('which rbenv')
      system!('rbenv rehash')
    else
      raise 'Could not execute `bundle` command after installing bundler gem!'
    end
  end

  puts "\n== Installing Yarn =="
  system('npm list -g yarn') || system!('npm install -g yarn')
  unless system('which yarn')
    if system('which nodenv')
      system!('nodenv rehash')
    else
      raise 'Could not execute `yarn` command after installing yarn npm package!'
    end
  end

  puts "\n== Running bin/update =="
  system! 'DISABLE_MIGRATIONS=1 bin/update'

  puts "\n== Preparing database =="
  system! 'bin/rails db:setup'
end
